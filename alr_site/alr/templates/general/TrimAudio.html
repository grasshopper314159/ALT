<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  {% load static %}
	<script src="{% static '/js/p5.js'%}"></script>
	<script src="{% static '/js/addons/p5.sound.js'%}"></script>
	<script src="{% static '/js/addons/p5.dom.js'%}"></script>
	  <!-- Load p5 library from CDN,  THIS WAS TOO SLOW
	//<script src="https://cdn.jsdelivr.net/npm/p5@0.10.2/lib/p5.js"></script>
  //<script src="http://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.6/addons/p5.dom.js"></script>
  //<script src="http://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.6/addons/p5.sound.js"></script>
	-->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- LET'S CONSIDER HOSTING THESE ON OUR SERVER-->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <!-- localized stylesheets -->
  <link rel="stylesheet" href="{% static '/css/master.css' %}"></style>

  <!--  start of script *****************************************************************************
        p5 will automatically call preload, setup and draw.  Draw is called ~50-60 times per second
        p5 may not play well with other javascript code.  It has a lot of global variables.  It is
        possible to run in instance mode to mitigate this, if necessary (see p5 website)  -->

  <script >
    //*************************  variables **********************************
    console.log('START');
    var soundFile, peaks;
    let recorderState = 0; // state 0: nothing, state 1: recording,  state 2: audio recorded, state 3: overwrite warning  --> change to enum?
    let audio_message, secondStr, tenthsStr, startTimeStr, endTimeStr, clipDurStr;
    audio_message = secondStr = tenthsStr = startTimeStr = endTimeStr = clipDurStr = " ";
    // myE is short for clipStateEnum.  JS doesn't have real enums, but this works.  If speed is an issue, change strings to 1,2,3,4,5 for faster comparison
    let myE = {NOSTART: "no times yet", STARTONLY: "has start time", ENDONLY: "needs start time", DONE: "has start and end time", SAVED: "has been saved to DB", INVALID: "end time < start time"};
    let clipState = myE.NOSTART;
    let myGrey = (200,200,200);
    let audio_background_color = myGrey;
    let recording_time, seconds, ready, playheadTime = 0;
    // These are the positions for the time text on the drawing canvas
    let startMarkPosX = 20;
    let startMarkPosY = 160;
    let endMarkPosX = 120;
    let endMarkPosY = 160;
    let durMarkPosX = 220;
    let durMarkPosY = 160;
    let startTime, endTime;
    let canvasHeight = 180;
    let canvasWidth = 650;
    let drawBox = 0; //flag to add a box to indicate saved clip
    let drawBoxList = [];
    let clipBoxColor = 'rgba(0,255,0, 0.25)';
    let dragging = false;
    let bigAudioId;

    //********************** main p5 functions **********************************

    // PRELOAD everything in here finishes before setup and draw run
    function preload() {
      //getAudioContext().resume();
      // '{% if me
      //   ssages %}'
      // '{% for
      //    message in messages %}'
      // message = '{{ mes
      // sage }}'
      // message = message.split(' ')
      // console.log(message)
      // console.log(message[1])
      // console.log(typeof(message))
      // message = 'user_12_gib/mySound_10.wav'
      // prefix = "{% static '/bigAudioFiles/"'%}"   + message[0] + "/"
      // soundFile = loadSound("{% static
      // '/../media/'%}" + message);
      // '{% en
        // dfor %}'
      // '{% end
        // if %}'
      soundFile = loadSound("{% static '/sounds/french_1.wav'%}"); //# 'ibaudiofiles/' lblb message.id rbrb '/' lblb message.filename rbrb # lb = { , rb = }
      console.log('PRELOAD');
      recorderState=2;  //ready to play clip
      // console.log(typeof(soundFile))
      // getMethods = (obj) => Object.getOwnPropertyNames(obj);
      // console.log(getMethods(soundFile));
    }

    // SETUP Run starts before draw, but not guaranteed to finish before draw
    function setup() {
      getAudioContext().resume(); //in the console there is an error that pop up that alerts you to add this
      console.log('setup1');  // for debugging
      recording_time = 0;  //remnant from upload audio.  turn this into soundFile length?
      var canvas = createCanvas(canvasWidth, canvasHeight);
      canvas.parent('trim_audio_container');
      canvas.style("visibility", "visible");
      background(audio_background_color);
      fill(0,0,0);  //draws in black
      console.log('setup2'); // for debugging
      makePeaks(soundFile);
      // cut and paste this in to prefill big_audio id for form submitting
      // needs testing
//      window.onload = function(){
  console.log("bigAudioId:  ", bigAudioId)
  console.log("bigAudioIdType:  ", typeof(bigAudioId))
      document.getElementById('formBigAudioID').value = bigAudioId;
//      };

    }
    // DRAW  Runs ~50 to 60 times per second
		function draw() {
      console.log(dragging)
      //cursor(ARROW)
			//getAudioContext().resume();  // I thought I would need this.  Gives a bunch of errors in the console though
			//resizeCanvas(600, 150, true);  // if we dynamically resize canvas, may use this function
			background(audio_background_color);  // need to force a redraw for every frame
			beginShape();  // Draws wave form
			for (i = 0; i < peaks.length; i++) {
				vertex(i, map(peaks[i], -1, 1, height, 0));
			}
			endShape();
      // playHeadTime is needed to draw the playhead. Don't want to update
      // playHeadTime if song is paused or being dragged
			if (soundFile.isPlaying() && dragging === false) {
				playheadTime=soundFile.currentTime();
			}
      checkCursor();
      if (dragging === false) {
        drawPlayhead(playheadTime);
      }
			else {  // moves playHeadTime to match the location of the mouse while dragging
        playheadTime = map(mouseX, 0,  width, 0, soundFile.duration());
        drawPlayhead(playheadTime);
      }
      text("Clip start: "+startTimeStr, startMarkPosX, startMarkPosY);
      text("Clip end: "+endTimeStr, endMarkPosX, endMarkPosY);
      text("Clip length: "+clipDurStr, durMarkPosX, durMarkPosY);
      //text("Playhead x: "+ map(playheadTime, 0, soundFile.duration(), 0, width).toFixed(2) , durMarkPosX+100, durMarkPosY);
      //text("MouseX: "+ mouseX.toFixed(2), durMarkPosX+220, durMarkPosY);

      //draws boxes to show saved clips
      for (i = 0; i < drawBoxList.length; i++) {
        fill('rgba(0,255,0, 0.25)');
        rect(drawBoxList[i][0], 0, drawBoxList[i][1], drawBoxList[i][2]);
        fill(0);
      }
    }

//***********************  Helper Functions ****************************************************************\
      // TODO
      // function to find the next quiet spot and atumatically make a clip
      // sensitivity function (and slider) for above function
      // make generator function to give new colors for clip boxes--> only useful for overlapping clips?
      // fix save audio
      // work positioning of waveform and dynamic sizing
      // fix drag so it doesn't start playing immediately after drag
      // change to single play/pause button
      // fix layout of buttons, canvas
      // make it so when the canvas is clicked it toggles play and pause
      // Make a list of the saved clips so one could be selected and edited
      //    or make boundaries of boxes draggable? or both?
      // Decide whether clips are uploaded to database by form submit
      //    button or save icon button

      //Changes the cursor to a hand when it's close to the playHead
      function checkCursor() {
        playHeadX = map(playheadTime, 0, soundFile.duration(), 0, width);
        if (mouseX > playHeadX-3 && mouseX < playHeadX+3 && mouseY > 0 && mouseY < height) {
          cursor(HAND);
        } else {
          cursor(ARROW);
        }
      }

      function mousePressed() {
      // Did I click on the playhead? then set dragging to true
      playHeadX = map(playheadTime, 0, soundFile.duration(), 0, width);
      if (mouseX > playHeadX-3 && mouseX < playHeadX+3 && mouseY > 0 && mouseY < height) {
        dragging = true;
        // prevent default behavior
        return false;
      }
    }

    function mouseReleased() {
      // Quit dragging
      if (dragging === true) {
        dragging = false;
        soundFile.stop(); //trying to stop the clip from playing immediately -test this
        playheadTime = map(mouseX, 0,  width, 0, soundFile.duration());
        console.log("playheadtime:  "+playheadTime);
        if (playheadTime < 0) {playheadTime = 0;} // bound check
        else if (playheadTime > soundFile.duration()) {playheadTime = soundfile.duration()-0.2;}
        //soundFile.play(0,1,.5,playheadTime,soundFile.duration());
        soundFile.stop();  // jump doesn't work unless you stop it first
        soundFile.jump(playheadTime);
      }
      // prevent default behavior
      return false;
    }

      // makeBox finds the coordinates needed to draw a clip box in draw()
      function makeBox() {
        boxXstart = map(startTime, 0, soundFile.duration(), 0, width);
        boxXend = map(endTime, 0, soundFile.duration(), 0, width);
        boxWidth = boxXend - boxXstart;
        tempParams = [boxXstart, boxWidth, height]
        console.log(tempParams)  //for debugging
        drawBoxList.push(tempParams)
      }

      function setStartTime() {
        startTime = playheadTime.toFixed(2);
        startTimeStr = startTime,toString()
        setState();  // e.g. valid clip, invalid, beginning time only, end only
      }

      function setEndTime() {
        endTime = playheadTime.toFixed(2);
        endTimeStr = endTime.toString();
        setState(); // e.g. valid clip, invalid, beginning time only, end only
      }

      // called whenever mark start, mark end, are called
      // e.g. valid clip, invalid, beginning time only, end only
      function setState() {
        if (!isNaN(parseInt(startTimeStr)) && isNaN(parseInt(endTimeStr))) {
          clipState = myE.STARTONLY;
          clipDurStr = " ";
        }
        else if (isNaN(parseInt(startTimeStr)) && !isNaN(parseInt(endTimeStr))) {
          clipState = myE.ENDONLY;
          clipDurStr = " ";
        }
        else if (!isNaN(parseInt(startTimeStr)) && !isNaN(parseInt(endTimeStr))) {
          if (parseInt(startTimeStr) < parseInt(endTimeStr)) {
            clipState = myE.DONE;
            clipDur = endTime - startTime;
            clipDurStr = clipDur.toString();
          }
          else {
            clipState = myE.INVALID;
            clipDurStr = "End time must be after start time."
            clipDur = -1;
          }
          // Do I need a flag for saved?
        }
        console.log(clipState);
      }


      // getPeaks returns a list of amplitude peaks.  Can take a paramter to make more
      // peaks (looks more detailed then).  Defaults to 5x window size
      function makePeaks(soundFile) {
          peaks = soundFile.getPeaks();
      }
      // This is the red line on the waveform
      function drawPlayhead(playheadTime) {
        noStroke();  // necessary?
        fill(255,0,0);
        // apparently width, height are p5 automagically created variables descripting canvas.
        // may need to replace with canvasWidth/ canvasHeight at some point
        rect(map(playheadTime, 0, soundFile.duration(), 0, width), 0, 2, height);
        fill(0,0,0);
      }

		// runs when play button is clicked
    function play() {
      getAudioContext().resume();
      console.log(recorderState);  // for debugging
      if (recorderState === 0) {  // remnant from upload audio
        audio_message = 'Nothing to play.  Record audio first.';
      } else if (recorderState === 1) {  // this recorderState is a remnant from upload audio
        audio_message = 'Currently recording.  Press the recording icon to stop.';
      } else if (recorderState === 2 || recorderState ===3) {
        audio_background_color = myGrey;
        audio_message = 'Playing.';
        soundFile.play();
        soundFile.playMode("restart")
        soundFile.onended(function() {audio_message = 'Press the Play icon to listen.';})
        recorderState = 2;
      }
    }

    // runs when pause button is clicked
		function pause() {
			// getAudioContext().resume();  //probably won't need this
      // this if is so if someone presses pause when it is already paused,
      // it doesn't reset playheadTime to zero. Not working right!!!!
			if (soundFile.isPlaying()) {
				playheadTime=soundFile.currentTime();
				soundFile.pause();
			}
		}

    // draws a clip box, saves trim into to  database

    function save_audio() {
      //Keep this code
      console.log(clipState);
      console.log(recorderState);
      // If we have a valid clip, makeBox() will add a clipBox to draw on the waveform
      // to indicate it has been saved
      if (clipState === myE.DONE) {
        //clipState = myE.SAVED;  // not sure where to put this yet
        makeBox()  //Really makeBox coordinaes.  Box is drawn in draw() (box corners are created in this function)        
        //javascript to click the submit button?
      }
    }

      // p5 copied code not using now but may be useful in save_audio()
      // try {
      //   let soundBlob = soundFile.getBlob();
      //   let serverUrl = 'http://jsonplaceholder.typicode.com/posts';
      //   let httpRequestOptions = {
      //     method: 'POST',
      //     body: new FormData().append('soundBlob', soundBlob),
      //     headers: new Headers({
      //       'Content-Type': 'multipart/form-data'
      //     })
      //   };
      //   httpDo(serverUrl, httpRequestOptions);

      // }
      // catch(err) {
      //   console.log(err);
      // }
      // write to database here

    // timeIt is a remnant from upload audio. May need it later
    function timeIt() {
      // 1 counter = 0.1 second
      recording_time++;
    } 
  </script>
  <!--  end of script *****************************************************************************-->
  <style>
    .h1 {
      font-size: 70px;
    }
    #background2 {
       background-image: url('{% static '/imgs/neutralBackground.jpg' %}');
       background-size: cover;
       overflow-y: scroll;
       height: 100%;
     }
    #centering {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #trim_audio_container {
      min-width: 700px;
      min-height: 200px;
      background-color: #5e001d;  /*  Go griz!  */
    }
    #buttons {
      text-align: center;
    }
  </style>
  <title>Trim Audio</title>
</head>

<body>
  <div class="w3-top" id="background2">
    <div class="home-background">
      <div class="w3-top" id="navigationBar">
        <a href="/"><img src="{% static '/imgs/alr_example_logo.jpg'%}" class="w3-col w3-circle w3-border-red w3-topbar w3-leftbar w3-rightbar w3-bottombar w3-hover-border-green" style="width:5em" alt="ALT Logo"></a>
        <a href="/" style="text-decoration: none"><h2 class="w3-rest" id="mainHeader"> Applied Language Resources </h2></a>
        <br>
        <div class="w3-bar w3-card w3-center" id="navigationButtons">
          <a class="w3-bar-item w3-button w3-padding-large w3-hide-medium w3-hide-large w3-right" href="javascript:void(0)" onclick="myFunction()" title="Toggle Navigation Menu"><i class="fa fa-bars"></i></a>
          {% if user.is_authenticated %}
          <a href="/viewAudio/" class="w3-bar-item w3-button w3-padding-large w3-hide-small w3-xlarge">View Audio</a>
          <a href="/uploadAudio/" class="w3-round w3-bar-item w3-button w3-padding-large w3-hide-small w3-xlarge">Upload Audio</a>
          <a href="/shareAudio/" class="w3-round w3-bar-item w3-button w3-padding-large w3-hide-small w3-xlarge">Share Audio</a>
          <a href="/rateAudio/" class="w3-round w3-bar-item w3-button w3-padding-large w3-hide-small w3-xlarge">Rate Audio</a> <!--Need this here for UI testing. Will change later.-->
          {% endif %}
          {% if user.is_anonymous %}
          <a href="/signUp/" class="w3-round w3-bar-item w3-button w3-padding-large w3-hide-small w3-xlarge">Sign Up</a>
          <a href="/aboutUs/" class="w3-round w3-bar-item w3-button w3-padding-large w3-hide-small w3-xlarge">About Us</a>
          {% endif %}
          <div class="w3-dropdown-hover w3-hide-small w3-right  w3-xlarge">
            <button class="w3-round w3-padding-large w3-button" title="More">Options <i class="fa fa-caret-down"></i></button>
            <div class="w3-dropdown-content w3-bar-block w3-card-4">
              <a href="/home/settings" class="w3-bar-item w3-button">Settings</a>
              <a href="/home/" class="w3-bar-item w3-button">Home</a>
              {% if user.is_authenticated %}
              <a href="/ajax/logoutUser" class="w3-bar-item w3-button">Log Out</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- form -->
    <br><br><br><br><br><br><br><br>
    <div class="w3-half"></div>

    <div style="float: center; margin: auto; width: 70%">
      <div id="fancyHeader">
        <br><br>
        <h1>Segment Your Audio File</h2>
      </div>
      <br>
      <div id="centering">
        <div id="trim_audio_container" >
        <!-- p5 canvas is attached to this div here -->
        </div>
      </div>
      <br>
      <div class="w3-bar" id="buttons">
        <div class="w3-btn">
          <!--- spacing on these buttons is wierd. Leaving it for now since we may move to dynamic resizing -->
          <i class="fa fa-play-circle-o fa-3x" aria-hidden="true" onclick="play()"></i>
          <h4 class="fancyText">Play</h4>
        </div>
        <div class="w3-btn" style="margin-left: 10vh" onclick="pause()">
          <i class="fa fa-pause-circle fa-3x" aria-hidden="true" onclick="pause()"></i>
          <h4 class="fancyText">Pause</h4>
        </div>
        <div class="w3-btn" style="margin-left: 10vh">
          <i class="fa fa-check-circle-o fa-3x" aria-hidden="true" onclick="setStartTime()"></i>
          <h4 class="fancyText">Mark Start</h4>
        </div>
        <div class="w3-btn" style="margin-left: 10vh">
          <i class="fa fa-window-close fa-3x" aria-hidden="true" onclick="setEndTime()"></i>
          <h4 class="fancyText">Mark End</h4>
        </div>
        <div class="w3-btn" style="margin-left: 10vh">
          <i class="fa fa-save fa-3x" aria-hidden="true" onclick="save_audio()"></i>
          <h4 class="fancyText">Save Audio Clip</h4>
        </div>
      </div>
    </div>
    <div class="w3-container">
      <div class="w3-half">
        <form class="audioForm">
          <!-- <label>Hide me!  (Big-audio id for posting)</label><br> -->
          <input type="hidden" id="formBigAudioID" name="big_audio_id" required></input>
          <br><br>
          <label style="padding: 13px;">Text (original)</label><br>
          <textarea name="original_text" style="vertical-align: middle;" rows="3" cols="75"></textarea>
          <br><br>
          <label style="padding: 13px;">Text (English)</label><br>
          <textarea name="english_text" style="vertical-align: middle;" rows="3" cols="75"></textarea>

          <br><br>
          <label style="padding: 13px;">Score (optional)</label><br>
          <input type="text" name="score" style="vertical-align: middle;"></input>
          <br><br>
          <label style="padding: 13px;">Word Count</label><br>
          <input type="text" name="word_count" style="vertical-align: middle;"></input>
          <br><br>
          <!-- TO DO: make this auto-filled  -->
          <label style="padding: 13px;">Length</label><br>
          <input type="text" name="length" style="vertical-align: middle;"></input>
          <br><br>
          <button type="submit" class="w3-btn w3-green" id="formUploadButton">Upload Audio Clip</button>
        </form>
      </div>
    </div>
  </div>
  <!-- display a message -->
  {% if messages %}
  {% for message in messages %}
  <div id='success' class="hide max-w-50vw w3-bottom w3-left w3-light-blue">
    <span onclick="this.parentElement.style.display='none'" class="w3-button w3-hover-red w3-large w3-display-topright">&times;</span>
    <h3>Message!</h3>
    <p>{{ message }}</p>
  </div>
  {% endfor %}
  {% endif %}
  <!--  -->
</body>
<script>
  '{% if messages %}'
  document.getElementById('success').style.display = 'block';
  '{% endif %}'
</script>
</html>


