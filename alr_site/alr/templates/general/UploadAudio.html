<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <script src="https://cdn.jsdelivr.net/npm/p5@0.10.2/lib/p5.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.6/addons/p5.dom.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.6/addons/p5.sound.js"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  {% load static %}
  <!-- localized stylesheets -->
  <link rel="stylesheet" href="{% static '/css/master.css' %}"></style>
  <!-- Load p5 library from CDN,  -->

  <script >
    let mic, recorder, soundFile;

    let state = 0; // state 0: nothing, state 1: recording;  state 2: audio recorded state 3: warned
    let audio_message, second_str = "", tenths_str="";
    let audio_background_color = 'grey';
    let recording_time, seconds = 0;

    function setup() {
      recording_time = 0;
      var canvas = createCanvas(500, 100);
      canvas.parent('record_audio_container');
      background(audio_background_color);
      fill(0);
      audio_message="Click the microphone icon to toggle recording."
      // create an audio in
      mic = new p5.AudioIn();

      // users must manually enable their browser microphone for recording to work properly!
      mic.start();

      // create a sound recorder
      recorder = new p5.SoundRecorder();

      // connect the mic to the recorder
      recorder.setInput(mic);

      // create an empty sound file that we will use to playback the recording
      soundFile = new p5.SoundFile();

          //fft = new p5.FFT();
        //fft.setInput(soundFile);
    }
      function draw() {
        getAudioContext().resume()
        background(audio_background_color);
        textSize(24);
        text(audio_message, 20, 40);
        if (recording_time == 0) {
          second_str = 0;
          tenths_str = 0; }
        else if (recording_time/10 < 0) { 
          second_str = "  "; 
          tenths_str = recording_time%10;}
        else {
          second_str = parseInt(recording_time/10);
          tenths_str = recording_time%10;}
        text("Length of recording: "+ second_str + "."+tenths_str + " seconds", 20, 80);
      }

    function record() {
      getAudioContext().resume()
      print(state);
      // use the '.enabled' boolean to make sure user enabled the mic (otherwise we'd record silence)
      if (state === 0 && mic.enabled) {
        // Tell recorder to record to a p5.SoundFile which we will use for playback
        recorder.record(soundFile);
        a_timer = setInterval(timeIt, 100);
        audio_background_color = 'red';
        audio_message = 'Recording now! Click to stop.';
        state = 1;
      } else if (state === 0 && !mic.enabled) {
        audio_background_color = 'orange';
        audio_message = 'You must allow access to your mic';
      } else if (state === 1) {
        recorder.stop(); // stop recorder, and send the result to soundFile
        clearInterval(a_timer)
        audio_background_color = 'green';
        audio_message = 'Press the Play icon to listen.';
        state = 2;
      } else if (state === 2) {
        audio_message = 'You have a recording.  Press record again to re-record.';
        audio_background_color = 'orange';
        state = 3;         // save file
      }
      else if (state === 3) {
        try { soundfile.stop() } // in case it is still playing
        catch(err) {}
        recorder.record(soundFile);
        audio_background_color = 'red';
        audio_message = 'Recording now! Click to stop.';
        state = 1;
        recording_time = 0;
        a_timer = setInterval(timeIt, 100);
      }
    }
    function play() {
      getAudioContext().resume()
      print(state);
      // use the '.enabled' boolean to make sure user enabled the mic (otherwise we'd record silence)
      if (state === 0) {
        audio_message = 'Nothing to play.  Record audio first.';
        //background(255, 0, 0);
      } else if (state === 1) {
        //recorder.stop(); // stop recorder, and send the result to soundFile
        audio_message = 'Currently recording.  Press the recording icon to stop.';
      } else if (state === 2 || state ===3) {
        audio_background_color = 'green';
        audio_message = 'Playing.';
        soundFile.play();
        soundFile.playMode("restart")
        soundFile.onended(function() {audio_message = 'Press the Play icon to listen.';})  
        state = 2;       // save file
      }
    }
    function save_audio() {
      print(state);
      // write to database here
    }

    function timeIt() {
      // 1 counter = 0.1 second
      recording_time++;
    }

  
  
  </script>
  <style>
    .h1 {
      font-size: 70px;
    }
    #background2 {
       background-image: url('{% static '/imgs/neutralBackground.jpg' %}');
       background-size: cover;
       overflow-y: scroll;
       height: 100%;
     }
  </style>
  <title>Upload Audio</title>
</head>

<body>
  <div class="w3-top" id="background2">
    <div class="home-background">
      <div class="w3-top" id="navigationBar">
        <a href="/"><img src="{% static '/imgs/alr_example_logo.jpg'%}" class="w3-col w3-circle w3-border-red w3-topbar w3-leftbar w3-rightbar w3-bottombar w3-hover-border-green" style="width:5em" alt="ALT Logo"></a>
        <a href="/" style="text-decoration: none"><h2 class="w3-rest" id="mainHeader"> Applied Language Resources </h2></a>
        <br>
        <div class="w3-bar w3-card w3-center" id="navigationButtons">
          <a class="w3-bar-item w3-button w3-padding-large w3-hide-medium w3-hide-large w3-right" href="javascript:void(0)" onclick="myFunction()" title="Toggle Navigation Menu"><i class="fa fa-bars"></i></a>
          {% if user.is_authenticated %}
          <a href="/viewData/" class="w3-bar-item w3-button w3-padding-large w3-hide-small w3-xlarge">View Data</a>
          <a href="/uploadAudio/" class="w3-round w3-bar-item w3-button w3-padding-large w3-hide-small w3-xlarge">Upload Audio</a>
          <a href="#" class="w3-round w3-bar-item w3-button w3-padding-large w3-hide-small w3-xlarge">User Management</a>
          <a href="/rateData/" class="w3-round w3-bar-item w3-button w3-padding-large w3-hide-small w3-xlarge">Rate Data</a> <!--Need this here for UI testing. Will change later.-->
          {% endif %}
          <a href="/aboutUs/" class="w3-round w3-bar-item w3-button w3-padding-large w3-hide-small w3-xlarge">About Us</a>
          {% if user.is_anonymous %}
          <a href="/signUp/" class="w3-round w3-bar-item w3-button w3-padding-large w3-hide-small w3-xlarge">Sign Up</a>
          {% endif %}
          <div class="w3-dropdown-hover w3-hide-small w3-right  w3-xlarge">
            <button class="w3-round w3-padding-large w3-button" title="More">Options <i class="fa fa-caret-down"></i></button>
            <div class="w3-dropdown-content w3-bar-block w3-card-4">
              <a href="/home/settings" class="w3-bar-item w3-button">Settings</a>
              <a href="/home/" class="w3-bar-item w3-button">Home</a>
              {% if user.is_authenticated %}
              <a href="/ajax/logoutUser" class="w3-bar-item w3-button">Log Out</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- form -->
    <br><br><br><br><br><br><br><br>
    <div class="w3-half">
      <form class="audioForm" style="float: left; margin-left: 5vh;">
        <label style="font-weight: bold">Choose a File to Upload:</label>
        <br>
        <input class="w3-bar-item" type="file" name="fileToUpload" id="fileToUpload" style="margin-left:0;"></input>
        <br><br>
        <label style="text-align: center;">Speaker</label>
        <br>
        <textarea style="vertical-align: middle;" rows="1" cols="30"></textarea>
        <br><br>
        <label>Text (Original)</label><br>
        <textarea style="vertical-align: middle;" rows="3" cols="70"></textarea>
        <br><br>
        <label>Text (English)</label><br>
        <textarea style="vertical-align: middle;" rows="3" cols="70"></textarea>
        <br><br>
        <label>Language</label><br>
        <textarea style="vertical-align: middle;" rows="1" cols="30"></textarea>
        <br><br>
        <input type="radio" name="private" value="private" style="margin-left:0">
        <label for="private">Private</label><br>
        <input type="radio" name="not_private" value="not_private" style="margin-left:0">
        <label for="not_private">Not Private</label><br>
        <br>
        <!--<button type="submit" class="w3-btn w3-green">Upload</button>-->
        <a href="/viewData/" class="w3-btn w3-green">Upload</a> <!-- Fake Upload button -->
        <br>
        <br>
      </form>
    </div>

<!--Record Audio -->

    <div style="float: right; margin: auto; width: 40%">
      <div id="fancyHeader">
        <h1>Record a New Audio File!!</h2>
      </div>
            <br>
      <div id="record_audio_container">
        <!-- put 5 canvas here -->
      </div>
      <br>
      <div class="w3-bar">
        <div class="w3-btn" style="margin-left: 10vh">
          <i class="fa fa-microphone fa-3x" aria-hidden="true" onclick="record()"></i>
          <h4 id="fancyText">RECORD</h4>
        </div>
        <div class="w3-btn">
          <i class="fa fa-play-circle-o fa-3x" aria-hidden="true" onclick="play()"></i>
          <h4 id="fancyText">PLAY</h4>
        </div>
        <div class="w3-btn" style="margin-left: 10vh">
          <i class="fa fa-save fa-3x" aria-hidden="true" onclick="save_audio()"></i>
          <h4 id="fancyText">SAVE</h4>
        </div>
      </div>     
    </div>
  </div>
</body>
</html>
